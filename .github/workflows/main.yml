  name: TSU Consult API CI/CD
  
  on:
    push:
      branches: [main]
  
  env:
    DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/tsu-consult-api
    DEPLOY_USERNAME: 'deployuser'
  
  jobs:
    build-and-deploy:
      runs-on: ubuntu-latest
      environment: Production
      
      steps:
        - name: üì• Checkout repository
          uses: actions/checkout@v4

        - name: üêç Setup Python
          uses: actions/setup-python@v4
          with:
            python-version: 3.12

        - name: üì¶ Install Poetry
          run: pip install poetry

        - name: üì¶ Install dependencies
          run: poetry install --no-interaction --no-ansi

        - name: üîê Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: üê≥ Build and Push Docker image
          uses: docker/build-push-action@v5
          with:
            context: .
            file: ./Dockerfile
            push: true
            tags: |
              ${{ env.DOCKER_IMAGE }}:latest
              ${{ env.DOCKER_IMAGE }}:${{ github.run_number }}

        - name: üöÄ Deploy to Server (SSH)
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ${{ env.DEPLOY_USERNAME }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            script: |
              set -e
              
              echo "üì¶ Backup previous container..."
              docker tag tsu-consult-api tsu-consult-api-backup || true
              
              echo "üì• Pull last image..."
              docker pull ${{ env.DOCKER_IMAGE }}:latest
              
              echo "üõë Stop and remove current container..."
              docker stop tsu-consult-api || true
              docker rm tsu-consult-api || true
              
              echo "üöÄ Launch new container with media volume and env file..."
              docker run -d \
                --name tsu-consult-api \
                -p 8001:8001 \
                --env-file /home/${{ env.DEPLOY_USERNAME }}/tsu-consult/tsu-consult.env \
                --network ${{ env.DEPLOY_USERNAME }}_tsu-consult_net \
                -v /home/${{ env.DEPLOY_USERNAME }}/tsu-consult/static:/vol/web/static \
                ${{ env.DOCKER_IMAGE }}:latest

        - name: üõ† Rollback
          if: failure()
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ${{ env.DEPLOY_USERNAME }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            script: |
              echo "‚ö†Ô∏è Deployment error. Rollback to previous container..."
              docker stop tsu-consult-api || true
              docker rm tsu-consult-api || true
              docker run -d \
                --name tsu-consult-api \
                -p 8001:8001 \
                --env-file /home/${{ env.DEPLOY_USERNAME }}/tsu-consult/tsu-consult.env \
                --network ${{ env.DEPLOY_USERNAME }}_tsu-consult_net \
                -v /home/${{ env.DEPLOY_USERNAME }}/tsu-consult/static:/vol/web/static \
                tsu-consult-api-backup